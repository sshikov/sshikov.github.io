<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="places-search">
    <template>
        <iron-ajax
            id="places-ajax"
            url="/json/places"
            params='{{_getParams()}}'
            handle-as="json"
            last-response="{{result}}"
            on-response="handleResponse"
            on-error="handleError"
            debounce-duration="300"
        >
        </iron-ajax>
    </template>
    <style>
//    	style='width: 330px;'
        div .markerPopup {
          display: block;
          width: 100%;
          position: relative;
          height: 0;
          padding: 56.25% 0 0 0;
          overflow: hidden;
        }

        img {
          position: absolute;
          display: block;
          max-width: 100%;
          max-height: 100%;
          left: 0;
          right: 0;
          top: 0;
          bottom: 0;
          margin: auto;
        }
    </style>
    <script>
        Polymer({
            is: 'places-search'
            , properties: {
                result: { type: Object }
	        	, baseUrl: {
        			type: String
        			, value: "/address"
	        	}
                , lat: {
                    type: Number
                }
                , lng: {
                    type: Number
                }
                , distance: {
                    type: Number
                }
                , params: {
                    type: Object
                    , computed: '_getParams()'
                }
                , map: {
                	type: Object
                	, value: null
                }
            }
            , ready: function () {
                console.log("ready");
            }
            , attached: function () {
                console.log("attached");
            }
            , attributeChanged: function(name, type) {
                if(this.getAttribute(name)!="")
                    console.log(this.localName + '#' + this.id + ' attribute ' + name + ' was changed to ' + this.getAttribute(name));
            }
            , handleResponse: function (data, request) {
                var headers= request.xhr.getAllResponseHeaders();
                var json= data.detail.response;
                console.log("places search complete", this.lat, this.lng, json);
                this.fire("places-search-complete", {'latlng': {'lat': this.lat, 'lng': this.lng}, 'result': this.searchComplete(json, {'lat': this.lat, 'lng': this.lng})});
            }
            , handleError: function (event) {
                console.log(event.detail.request);
                this.fire("places-search-error", event);
            }
            , _getParams: function () {
                return {
                    'lat': this.lat
                    ,'lng': this.lng
                    ,'distance': this.distance
                };
            }
    	    , search: function() {
                var ajax= document.getElementById("places-ajax");
                if(ajax) {
                    var params= ajax.get("params");
                    params.singleLine= this.street;
                    ajax.set("params", this._getParams());
                    ajax.generateRequest();
                }
            }
            , searchComplete: function(result, latlng) {
                console.log("places-search-complete", result);
                return _.map(result, function(place) {
                    var geometry= place.geometry;
                    var location= geometry.location;
                    var lat= location.lat, lng= location.lng;
                    var name= place.name;
                    var formattedAddress= place.formattedAddress!=null ? place.formattedAddress : place.vicinity;
                    var scope= place.scope;
                    var rating= place.rating;
                    var types= place.types;
                    var icon= place.icon;
                    var openingHours= place.openingHours;
                    if(openingHours) {
                        var openNow= openingHours.openNow;
                        var periods= openingHours.periods;
                        var weekdayText= openingHours.weekdayText;
//                          var permanentlyClosed;
                    }
//                    var distance= map.distance(location, latlng);

                    console.log("place", name, lat, lng, formattedAddress, rating, types);
                    var awIcon= L.AwesomeMarkers.icon({icon: 'coffee', markerColor: "cadetblue"});
					var thumbIcon= new L.DivIcon({
						className: 'leaflet-marker-photo'
						, html: '<div style="background-image: url('+icon+');"></div>​'
						, icon: { iconSize: [40, 40]}
					});

                    //'red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'
                    var placeMarker= L.marker([lat, lng], {
                        clickable: true
                        , draggable: false
                        , icon: thumbIcon // awIcon
                        , title: name
//                        , pane: 'places-pane'
//                            , marker-symbol: star
//                            keyboard: !this.noKeyboard,
//                            alt: this.alt,
//                            zIndexOffset: this.zIndexOffset,
//                            opacity: this.opacity,
//                            riseOnHover: this.riseOnHover,
//                            riseOffset: this.riseOffset
                    });
//                    placeMarker.on('move', function markerMove(moveEvent) {
//                        console.log("place-marker-move", moveEvent);
//                    });
                    var popup= "<div class='markerPopup leaflet-marker-photo-popup' style='overflow: hidden; max-width: 300px; max-height: 300px; width: 100%; height: 100%;'><b>"+name+" "+formattedAddress+"</b><br>";
                    var baseUrl= "https://maps.googleapis.com/maps/api/place/photo?key=AIzaSyC4x1s24YwMmaSPvBUdd6irHLywm8d-YlA&maxwidth=1920&maxheight=1080&photoreference=";
                    popup= popup+_.join(_.map(place.photos, function(photo, index) {
                        if($("#closest-place").attr("src")=="") {
                            $("#closest-place").attr("src", baseUrl+photo.photoReference);
                            $("#closest-place").attr("style", 'display: block; width: 100%; height: auto');
                            $("#closest-place").attr("title", name);
                        }
                        return "<a href='"+baseUrl+photo.photoReference+"'><img src='"+baseUrl+photo.photoReference+"' style='display: block; width: 100%; height: auto'></a><br>";
                    }), "");
                    popup= popup+"<br>Рейтинг: "+rating;
//                    popup= popup+"<br>Расстояние: "+distance;
                    popup= popup+"<br>Тип: "+_.join(types, ", ");
                    popup= popup+"</div>";
                    placeMarker.bindPopup(popup);
                    return placeMarker;
                });
            }
        });
    </script>
</dom-module>
