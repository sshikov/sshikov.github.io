<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="geomarketing-geocode">
    <template>
        <template is="dom-repeat" items="{{candidates}}">
            <ul><li>{{item.address}}</li></ul>
        </template>
        <iron-ajax
            id="geomarketing-geocoder"
            url="http://sbt-owr-264:6080/arcgis/rest/services/LocatorComposite/GeocodeServer/findAddressCandidates"
            params='{{_getParams()}}'
            handle-as="json"
            last-response="{{result}}"
            on-response="handleResponse"
            on-error="handleError"
            debounce-duration="300"
        >
        </iron-ajax>
    </template>
    <script>
        var precisions= {
            'point': ["SBRFPoint"]
            , 'street': ["SBRFPoint", "SBRFLine", "StreetsLocator"]
            , 'city': ["SBRFPoint", "SBRFLine", "StreetsLocator", "CitiesLocator"]
            , 'region': ["SBRFPoint", "SBRFLine", "StreetsLocator", "CitiesLocator", "RegionsLocator"]
        }
        Polymer({
            is: 'geomarketing-geocode'
            , properties: {
                result: { type: Object }
	        	, baseUrl: {
        			type: String
        			, value: "/address"
	        	}
                , street: {
                    type: String
                    , observer: '_streetChanged'
                    , reflectToAttribute: true
                }
                , params: {
                    type: Object
                    , computed: '_getParams()'
                }
                , candidates: {
                    type: Array
                }
                , maxResults: {
                    type: Number
                    , value: 10
                    , reflectToAttribute: true
                }
            }
            , ready: function () {
                console.log("ready");
            }
            , attached: function () {
                console.log("attached");
            }
            , attributeChanged: function(name, type) {
                if(this.getAttribute(name)!="")
                    console.debug(this.localName + '#' + this.id + ' attribute ' + name + ' was changed to ' + this.getAttribute(name));
            }
            , handleResponse: function (data, request) {
                var headers= request.xhr.getAllResponseHeaders();
//                console.log(headers);
                var json= data.detail.response;
                if(json.candidates.length && json.candidates.length>0) {
                    this.fire('candidates', {'candidates': json.candidates});
                }
                var usable= _.filter(json.candidates, function(candidate, index, list) {
//                    console.debug(candidate, candidate['address'], candidate['attributes'], candidate['location'], candidate['extent']);
                    var addrType= candidate['attributes']['Addr_type'];
                    var locator= candidate['attributes']['Loc_name'];
                    console.debug(addrType, locator, candidate['address']);
                    return _.includes(["PointAddress", "StreetAddress", "StreetName"], addrType)
                        && _.includes(["SBRFPoint", "SBRFLine", "StreetsLocator", "CitiesLocator"], locator);
                });
                if(usable.length>0) {
                    this.set("candidates", _.slice(usable, 0, this.maxResults));
                    console.debug(usable);
                    var result= usable[0];
                    var location= result['location'];
                    var precision= _.findKey(precisions, function(locators, key) {
                        return _.includes(locators, result['attributes']['Loc_name']);
                    });
                    this.fire(
                        'located'
                        , {
                            'lat': location.y
                            , 'lng': location.x
                            , 'text': result['address']
                            , 'precision': precision
                            , 'geometry': {
                                'location': location
                                , 'bounds': result['extent']
                            }
                        }
                    );
                }
            }
            , handleError: function (event) {
                this.set("candidates", []);
                console.log(event.detail.request);
            }
            , _getParams: function () {
                return {
                    'singleLine': this.street
                    ,'outFields':'*'
                    ,'maxLocations': 50
                    ,'f':'json'
                };
            }
    	    , filled: function () {
                return (this.street && this.street!="" && this.street.length>3);
    	    }
            , _streetChanged: function () {
                console.log(this.street);
                if(this.filled())
                    this.debounce('doSearch', function () {
        	        	this.geocode();
                    }, 300);
            }
    	    , geocode: function(onComplete) {
                this.set("candidates", []);
                var ajax= document.getElementById("geomarketing-geocoder");
                if(ajax) {
                    var params= ajax.get("params");
                    params.singleLine= this.street;
                    ajax.set("params", this._getParams());
                    ajax.generateRequest();
                }
            }
        });
    </script>
</dom-module>
