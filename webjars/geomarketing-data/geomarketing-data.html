<script src="./js/inputDataProcessor.js"></script>
<script src="./js/markerHelper.js"></script>
<!--<script src="/static/js/leaflet-dvf.js"></script>-->
<!--<script src="/static/js/leaflet.dvf.experimental.js"></script>-->

<dom-module id="geomarketing-data">
<style>
	:host {
		display: none;
    }
</style>

<template>
</template>

<script>
	Polymer({
		is: 'geomarketing-data'
		, properties: {
			inputDataFlats: {
				type: Array
			}
			, inputDataProfile: {
				type: Array
			}
			, inputDataASUN: {
				type: Array
			}
			, cities: {
				type: Array
				, value: []
			}
			, cityData: {
				type: Object
				, value: {}
			}
		}
		, preloadAmt: function preloadAmt(city) {
			var that= this;
			var amtp= $.getJSON("/json/amt/"+city).then(function(amt) {
				console.log("amt "+city);
				that.fire("data-amt-ready", {city: city, amt: amt});
				window.initialInputDataProfile= window.initialInputDataProfile.concat(amt);
				return amt;
			})
			, asunp= $.getJSON("/json/asun/"+city).then(function(asun) {
				console.log("asun "+city);
				that.fire("data-asun-ready", {city: city, asun: asun});
				window.initialInputDataASUN= window.initialInputDataASUN.concat(asun);
				return asun;
			})
			, marketrentp= $.getJSON("/json/marketrent/"+city).then(function(marketrent) {
				console.log("marketrent "+city);
				that.fire("data-marketrent-ready", {city: city, marketrent: marketrent});
				window.initialInputDataFlats= window.initialInputDataFlats.concat(marketrent);
				return marketrent;
			});
			that.set("cityData."+city, _.extend(that.get("cityData."+city), {'promices': {amt: amtp, marketrent: marketrentp, asun: asunp}}));
			var allData= $.when(amtp, asunp, marketrentp);
			return allData.then(function(initial, asun, marketrent) {
				that.set("cityData."+city, _.extend(that.get("cityData."+city), { 'data': { amt: initial, asun: asun, marketrent: marketrent }}));
				that.fire("data-all-ready", {city: city, amt: initial, asun: asun, marketrent: marketrent });
				console.log("preloaded all "+city);
//				console.debug(JSON.stringify(initial[0]));
//				console.debug(JSON.stringify(marketrent[0]));
//				console.debug(JSON.stringify(asun[0]));
				globals.inputData = inputDataProcessor.readInputData();
				markerHelper.populateMarkers(settings||{});
				var set= globals.activeMarkerSet;
				$("#my-map")[0].refreshGridScale(globals.map.map);
				$("#my-map")[0].refreshGrid(settings, globals.map.map);
				if (set.has('ATMPOS')) {
					globals.layers['ATMPOS'].addTo(globals.map.map);
				}
				if (set.has('VSP')) {
					globals.layers['VSP'].addTo(globals.map.map);
				}
				if (set.has('MARKETRENT')) {
					globals.layers['MARKETRENT'].addTo(globals.map.map);
				}
				if (set.has('RENT')) {
					globals.layers['RENT'].addTo(globals.map.map);
				}
			}
			, function(error) {
				console.log("failed "+error.statusText);
			});
		}
	  	, preloadCity: function preloadCity(city) {
  			console.log(city);
	  		return $.when(
  				$.getJSON("/json/amt/"+city).then(function(initial) {
	  				console.log("initial "+city);
  					window.initialInputDataProfile= window.initialInputDataProfile.concat(initial);
					_.extend(cityData[city], {'atm': initial.length});
	  				return initial;
	  			})
	  			, $.getJSON("/json/marketrent/"+city).then(function(marketrent) {
	  				console.log("rent "+city);
  					window.initialInputDataFlats= window.initialInputDataFlats.concat(marketrent);
					_.extend(cityData[city], {'marketrent': marketrent.length});
  					return marketrent;
	  			})
	  			, $.getJSON("/json/asun/"+city).then(function(asun) {
	  				console.log("asun "+city);
  					window.initialInputDataASUN= window.initialInputDataASUN.concat(asun);
					_.extend(cityData[city], {'rent': asun.length});
  					return asun;
	  			})
  			).then(function(initial, marketrent, asun) {
  				console.log("preloaded all "+city);
	  			console.debug(JSON.stringify(initial[0]));
  				console.debug(JSON.stringify(marketrent[0]));
  				console.debug(JSON.stringify(asun[0]));
	  		}
  			, function(error) {
	  			console.log("failed "+error.statusText);
	  		});
  		}
		, preloadOther: function preloadOther(city) {
			console.log("load city "+city);
			$.when(
				$.getJSON("data/other/atm/"+city+".json").then(function(atm) {
					console.log("atm "+city);
					window.initialInputData.concat(atm);
					_.extend(cityData[value.code], {'atm': atm.length});
					return atm;
				}),
				$.getJSON("data/other/atmother/"+city+".json").then(function(atmother) {
					console.log("atmother "+city);
					window.initialInputDataAtmOthers.concat(atmother);
					return atmother;
				}),
				$.getJSON("data/other/pos/"+city+".json").then(function(pos) {
					console.log("pos "+city);
					window.initialInputDataPos.concat(pos);
					return pos;
				}),
				$.getJSON("data/other/posother/"+city+".json").then(function(posother) {
					console.log("posother "+city);
					window.initialInputDataPosOthers.concat(posother);
					return posother;
				}),
				$.getJSON("/vsp/"+city).then(function(vsp) {
					console.log("vsp "+city);
					window.initialInputDataVsp.concat(vsp);
					return vsp;
				})
			).then(function(atm, atmother, pos, posother, vsp) {
				console.log("all");
				console.log(JSON.stringify(atm[0]));
				console.log(JSON.stringify(atmother[0]));
				console.log(JSON.stringify(pos[0]));
				console.log(JSON.stringify(posother[0]));
				console.log(JSON.stringify(window.initialInputDataVsp))
				console.log(JSON.stringify(vsp[0]));
			}
			, function(error) {
				console.log("failed "+error.statusText);
			});
		}
		, loadStreets: function(city) {
			var streetp= $.getJSON("/json/streets/"+city);
			var that= this;
			return streetp.then(function(streets) {
//				console.log("streets", streets);
				that.set("cityData."+city, _.extend(that.get("cityData."+city), { 'streets': streets}));
				return streets;
			});
		}
		, loadGeojson: function(code) {
			return $.getJSON("/json/geojson/"+code).then(function(geojson) {
				return JSON.parse(geojson.geojson);
			});
		}
		, loadCities: function() {
			return $.getJSON("/json/cities").then(function(cities) {
//				console.log("cities ", cities);
				return _.map(cities, function(value, index) {	// todo а оно надо? структура уже такая как хочется
					return {
						latName: value.latName
						, text: value.city
						, x: value.x
						, y:  value.y
						, xmin: value.xmin
						, xmax: value.xmax
						, ymin: value.ymin
						, ymax: value.ymax
						, code: value.code
					};
				});
			});
		}
		, ready: function ready() {
			console.log("geomarketing-data ready!");
			globals.cityData= {};
			this.set("cities", this.loadCities().then((function(cities) { return cities; }).bind(this)));

			if(typeof window.initialInputDataFlats === 'undefined') window.initialInputDataFlats = [];
			if(typeof window.initialInputDataASUN === 'undefined') window.initialInputDataASUN = [];
/*
			if(typeof window.saleInputData === 'undefined') window.saleInputData = [];
			if(typeof window.zalogiInputData === 'undefined') window.zalogiInputData = [];
			if(typeof window.initialInputDataProfile === 'undefined') window.initialInputDataProfile = [];

			if(typeof window.initialInputData=== 'undefined') window.initialInputData= [];
			if(typeof window.initialInputDataAtmOthers=== 'undefined') window.initialInputDataAtmOthers= [];
			if(typeof window.initialInputDataPos=== 'undefined') window.initialInputDataPos= [];
			if(typeof window.initialInputDataPosOthers=== 'undefined') window.initialInputDataPosOthers= [];
			if(typeof window.initialInputDataVsp=== 'undefined') window.initialInputDataVsp= [];
*/
		}
	});
	</script>
</dom-module>
