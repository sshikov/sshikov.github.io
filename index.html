<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Открытые данные</title>
	<script src="/webjars/lodash/lodash.min.js"></script>
	<script src="/webjars/jquery/jquery.min.js"></script>
	<script src="./js/globalVars.js"></script>

	<script src="/webjars/d3/d3.js"></script>
	<script src="./js/chroma.js"></script>

	<link href="/webjars/material-design-icons/material-icons.css" rel="stylesheet"/>
	<link href="./css/font-awesome.css" rel="stylesheet"/>
	<link href="./css/leaflet.awesome-markers.css" rel="stylesheet"/>
	<link href="./css/MarkerCluster.css" rel="stylesheet"/>
	<link href="./css/MarkerCluster.Default.css" rel="stylesheet"/>

	<!--<script src="components/webcomponentsjs/webcomponents-lite.js"></script>-->
	<script>
    /* this script must run before Polymer is imported
    window.Polymer = {
        dom: 'shadow',
        lazyRegister: true
    };
    */
    </script>
	<link rel="import" href="/webjars/polymer/polymer.html">

	<!--<link rel="import" href="../iron-component-page/iron-component-page.html">-->
	<link rel="import" href="/webjars/iron-icon/iron-icon.html">
	<!--<link rel="import" href="/webjars/iron-ajax/iron-ajax.html">-->
	<link rel="import" href="/webjars/iron-icons/maps-icons.html">
	<link rel="import" href="/webjars/iron-icon/iron-icon.html">
	<link rel="import" href="/webjars/iron-icons/iron-icons.html">
	<link rel="import" href="/webjars/iron-iconset/iron-iconset.html">
	<link rel="import" href="/webjars/iron-input/iron-input.html">
	<link rel="import" href="/webjars/iron-selector/iron-selector.html">
	<link rel="import" href="/webjars/iron-pages/iron-pages.html">
	<!--link rel="import" href="/webjars/paper-tabs/paper-tabs.html"-->
	<link rel="import" href="/webjars/paper-item/paper-item.html">
	<link rel="import" href="/webjars/paper-item/paper-icon-item.html">
	<link rel="import" href="/webjars/paper-input/paper-input.html">
	<link rel="import" href="/webjars/paper-button/paper-button.html">
	<link rel="import" href="/webjars/paper-listbox/paper-listbox.html">
	<link rel="import" href="/webjars/paper-icon-button/paper-icon-button.html">
	<link rel="import" href="/webjars/paper-dropdown-menu/paper-dropdown-menu.html">

	<!--link rel="import" href="/webjars/paper-interval-slider/paper-interval-slider.html"-->
	<!--<link rel="import" href="bower_components/paper-card/paper-card.html">-->
	<!--link rel="import" href="/webjars/paper-dialog/paper-dialog.html"-->
	<!--link rel="import" href="/webjars/paper-menu-button/paper-menu-button.html"-->
	<!--link rel="import" href="/webjars/paper-drawer-panel/paper-drawer-panel.html"-->
	<!--link rel="import" href="/webjars/paper-drawer-panel/paper-header-panel.html"-->
	<!--<link rel="import" href="/webjars/paper-drawer-panel/paper-toolbar.html">-->
	<!--<link rel="import" href="/webjars/paper-autocomplete/paper-autocomplete.html">-->
	<!--<link rel="import" href="/webjars/paper-autocomplete/paper-autocomplete-suggestions.html">-->

	<!--<link rel="import" href="/webjars/neon-animation/animations/fade-in-animation.html">-->
	<!--<link rel="import" href="/webjars/neon-animation/animations/fade-out-animation.html">-->
	<!--<link rel="import" href="/webjars/neon-animation/animations/opaque-animation.html">-->
	<!--<link rel="import" href="/webjars/web-animations-js/web-animations-js.html">-->

	<link rel="import" href="/webjars/iron-flex-layout/iron-flex-layout-classes.html">
	<!-- include classes in the main document -->
	<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning"></style>


	<!--link rel="import" href="/webjars/platinum-sw/platinum-sw-elements.html"-->

	<!--<link rel="import" href="/webjars/google-map/google-map-search.html">-->
	<!--<link rel="import" href="/webjars/google-signin/google-signin.html">-->

	<link rel="import" href="/webjars/leaflet-map/leaflet-map.html">
	<!--link rel="import" href="/webjars/geo-codec/geo-codec.html"-->

	<!--link rel="import" href="/webjars/yandex-geocode/yandex-geocode.html">
	<link rel="import" href="/webjars/arcgis-geocode/arcgis-geocode.html">
	<link rel="import" href="/webjars/geomarketing-geocode/geomarketing-geocode.html">
	<link rel="import" href="/webjars/geomarketing-data/geomarketing-data.html">
	<link rel="import" href="/webjars/geomarketing-settings/geomarketing-settings.html">
	<link rel="import" href="/webjars/geomarketing-cities/geomarketing-cities.html">
	<link rel="import" href="/webjars/places-search/places-search.html">
	<link rel="import" href="/webjars/cian-search/cian-search.html"-->

	<!--link rel="import" href="/webjars/dadata-ajax/dadata-address.html">
	<link rel="import" href="/webjars/geomarketing-map/geomarketing-map.html"-->
	<!--link rel="import" href="/webjars/address-autocomplete/address-autocomplete.html">
	<link rel="import" href="/webjars/login-form/login-form.html"-->

	<link rel="import" href="./my-controls.html">

	<style>
	html, body {
		width: 100%;
		height: 100%;
		margin: 0;
		padding: 0;
		font-family: Arial;
		color: #656989;
	}
        leaflet-map {
/*		position: absolute;
		bottom: 0;
		top: 0;
*/
		width: 100%;
		height: 800px;
        }

	.top {
		background: linear-gradient(90deg, #1BAC9B, #66A850);
		height: 100px;
		color: white;
	}

	.bottom {
		background-color: #656989;
		height: 100px;
		color: white;
	}

	#right {
		background-color: #99DDBB;
//		width: 20%;
	}

	.chart {
		background: linear-gradient(0deg, #1BAC9B, #66A850);
		width: 30%;
		min-width: 500px;
	}

	.logo {
		width: 80%;
		height: 80%;
	}

	#reset {
		background-color: #66A850;
		color: white;
		width: 20em;
	}
	</style>
	<link href="./css/main.css" rel="stylesheet"/>
	<script src="./js/leaflet-providers.js"></script>
	<script src="./js/leaflet.awesome-markers.min.js"></script>
	<script src="./js/TileLayer.Grayscale.js"></script>
	<script>
     		var regionsData= {};
		var regionsSelected= {};
		var layersSelected= {};
		var layers= {};

       		var highlightRegion= function highlightRegion(e, feature) {
       			console.log('chart Region: '+feature.properties.regionName, globals.regionsSelected);
       			var layer = e.target;
       			var latlng= e.latlng;
       			if (!L.Browser.ie && !L.Browser.opera) { layer.bringToFront(); }

       			// set the dimensions and margins of the graph
       			var margin = {top: 20, right: 20, bottom: 30, left: 50},
       				width = 500 - margin.left - margin.right,
       				height = 500 - margin.top - margin.bottom;

       			// set the ranges
       			var x = d3.scaleTime().range([0, width]);
       			var y = d3
       				.scaleLinear() // .scaleLog()
       				.range([height, 0])
       			;

       			// append the svg obgect to the body of the page
       			// appends a 'group' element to 'svg'
       			// moves the 'group' element to the top left margin
       			var svg = d3.select("#chart")
       				.html("")
       				.append("svg")
       					.attr("width", width + margin.left + margin.right)
       					.attr("height", height + margin.top + margin.bottom)
       					.append("g")
       						.attr("transform",
       						"translate(" + margin.left + "," + margin.top + ")")
       			;

       			var html= [];
       			var i= 0;
       			var colors= ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff'];
       			var cols= [];

       			_.forEach(regionsSelected, function(v, k) {
       				console.log(k,v);
       				var color= colors[i % 6];
       				html.push("<li style='color: "+color+";'>"+k+"</li>");
       				var data= regionsData[v.region].values;
       				var region= v.region;	// k

       				// define the line
       				var valueline = d3.line()
       					.curve(d3.curveBasis)
       					.x(function(d) { return x(d.date); })
       					.y(function(d) { return y(d.value); });

       				// Scale the range of the data
       				x.domain(d3.extent(data, function(d) { return d.date; }));
       				y.domain([d3.min(data, function(d) { return d.value; }), d3.max(data, function(d) { return d.value; })]);

       				// Add the valueline path. todo color
       				svg.append("path")
       					.data([data])
       					.attr("stroke", color)	//chroma.brewer.Blues[i]
       					.attr("fill", "none")
       					.attr("d", valueline)
       				;
       				i++;
       			});

       			// Add the X Axis
       			svg.append("g")
       				.attr("transform", "translate(0," + height + ")")
       				.call(d3.axisBottom(x)
//							.ticks(3)
       					.tickFormat(d3.timeFormat("%Y-%m"))
       					.tickArguments([d3.timeMonth.every(6)])
       				)
       			;

       			// Add the Y Axis
       			svg.append("g")
       				.call(d3.axisLeft(y)
//							.tickFormat(d3.format(".3n"))
       				)
       		  	;

       			var regions= "<ul>"+_.join(html, "")+"</ul>";
       			$("#selectedRegions").html(regions);

       			if(Object.keys(regionsSelected).length>0) {
				$("#chart").show();
       				$("#selectedRegions").show();
       			} else {
				$("#chart").hide();
       				$("#selectedRegions").hide();
       			}
       		};

       		var depositLoader= function() {
       			var map= $("#map")[0];
       			var df= d3.timeParse("%d.%m.%Y");
       			d3.text('./data/regions.csv', function(csv) {
       				var dsv= d3.dsvFormat('|');

       				dsv.parse(csv)
       				.filter(function(d) { return d.osmid!=0;})
       				.map(function(d) {
					loadGeoJson(d.osmid, d.region);
				})


        			d3.text('./data/deposits.csv', function(csv) {
        				var dsv= d3.dsvFormat('|');
        				var deposits= dsv.parse(csv);
        				var grouped= d3.nest()
        					.key(function(d) { return d['Регион']; })
						.rollup(function(periods) {
							return periods;
						})
        					.map(deposits)
        				;
					console.log(grouped);
	 				var regionsList= [];
 					_.forEach(grouped.keys(), (value, key)=> { regionsList.push({code: key, text: value}); });
 					$("#controls")[0].set("regions", regionsList);
 					$("#controls")[0].set("parameters", [{code: 1, text: "Средняя сумма заявки на потребительский кредит"}]);

        				var data= deposits
 //       				.filter(function(d) { return d['Регион']!='Россия';})
        				.map(function(d) {
        					var region= d['Регион'];
        					var value= Number(d['Показатель']);
        					var date= df(d['Дата']);
        					if(!regionsData[region]) {
        						regionsData[region]= {values: []};
        					}
        					regionsData[region].values.push({'date': date, 'value': value});
        				});
        				_.forEach(regionsData, function(region, key) {
 //       					console.log(region, key);
 //					loadByName(region.text);
        				})
	       			});

       			})

       		};

		var style= function(feature) {
      		    	return {
	                  	fill: true
        	          	, stroke: true
                	  	, color: '#EFEFEF'
	                  	, weight: 1
        	          	, opacity: 0.5
                	  	, dashArray: ''
                  		, fillColor: '#66A850'
	                  	, fillOpacity: 0.25
              		}
		};

		var loadByName= function(regionName) {
			var url = "https://nominatim.openstreetmap.org/search";
			var map= $("#map")[0].map;
			$.getJSON(url, {q: regionName, format: "json", polygon_geojson: 1}).then(function(json) { 
				var layer= L.geoJson(json.geojson, {});
				layer.addTo(map);
			});
		};

		var loadGeoJson= function(id, region) {
			var map= $("#map")[0].map;
			$.getJSON("https://nominatim.openstreetmap.org/reverse", {'format': 'json', "osm_id": id, 'polygon_geojson': 1, "osm_type": "R"})
			.then(function(json) { 
				if(json.error) {
					console.log(id, region, json.error);
					return;
				}
//				console.log(json); 
				var map= $("#map")[0].map;
				var feature= {
					type: "Feature"
					, properties: {
						id: id
						, selected: false
						, regionName: region
						, display_name: json['display_name']
						, address: json.address
					}
					, geometry: json.geojson
				};
		                var level= 410+(!!json.address['city'] ? 15 : (!!json.address['state'] ? 10 : 5));
				console.log(json.address, level);
                		if(!map.getPane('pane'+level))
			                    map.createPane('pane'+level).style.zIndex = level;

				var layer= L.geoJson(feature, {
					style: style
					, pane: 'pane'+level
					, onEachFeature: function onEachFeature(feature, layer) {
      						layer.on({
			       	                        mouseover: function highlightFeature(e) {
								console.log('mouseover', feature.properties.address);
//       	                			        	if(!feature.properties.selected)
//       	                        					return highlight(e, feature);
       							}
			       	                        , mouseout: function resetHighlight(e) {
								console.log('mouseout', feature.properties.address);
//       	                			        	if(!feature.properties.selected)
//    		                        				layer.setStyle(style(feature));
       							}
       							, click: function click(e) {
			       	                        	var region= feature.properties.regionName;
       	                			        	var st= style(layer);
			       	                        	var selected= !!feature.properties.selected;
								var selected= !!layer.options.selected;
       	                			        	if(e.originalEvent.ctrlKey) {
       		                        				console.log('ctrl-click', e, feature.properties.regionName, selected);
       									if(!selected) {	// выбор
       										st.color= '#FFA000';//#FFA000
		   								st.fillOpacity= 1.0;
										st.weight= 2;	
   										regionsSelected[region]= {id: id, region: feature.properties.regionName, values: feature.properties.values}
										layersSelected[id]= e.target;
       									} else {	// отмена
       										var defst= style(feature);
       										st.color= defst.color; //'#333366';
   										st.fillOpacity= defst.fillOpacity; //0.1;
   										delete regionsSelected[region];
										delete layersSelected[id];
       									}
       									feature.properties.selected= !selected;
									layer.options.selected= !selected;
			       	                        	} else {
       		        			                	console.log('click', e, feature.properties.regionName, selected);
			       	                        	}
       	                			        	layer.setStyle(st);
			       	                        	return highlightRegion(e, feature);
	      						}
       						});
					}
				});
				layer.addTo(map);
				if(id==60189)
					map.fitBounds(layer.getBounds());

				layers[id]= layer;
			}).fail(function(error) {
				console.log(error, id, region);
			});
		}

		$(document).ready(function(e) {
	    		$("#map").on("map-ready", function(e) {
	    			var map= $("#map")[0].map;
    				L.tileLayer.grayscale('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 })
	    				.addTo(map)
    				;
//	    			loadGeoJson(60189);
	    			depositLoader();
	    		});
	    		$("#reset").on("click", function(e) {
	       			_.forEach(regionsSelected, function(v, k) {
					console.log(k, v);
					Object.keys(layers[v.id]._layers)[0];
					layersSelected[v.id].options.selected= false;
					layersSelected[v.id].setStyle(style(layersSelected[v.id].feature));
                        	});
				regionsSelected= {};
				$("#chart").html("");
				$("#selectedRegions").html("");

	    		});		
		});

	</script>
</head>
<body unresolved>
	<iron-iconset icons="device action navigation maps image editor" size="24"></iron-iconset>
	<div class="layout vertical">
		<div class="layout horizontal top">
			<div><h2>Открытые данные</h2></div>
			<div class="flex"></div>
			<div><img class="logo" src="images/white-logo-01.png"></div>
		</div>
		<div class="layout horizontal">
			<leaflet-map latitude="55.753" longitude="37.629" zoom="13" maxZoom="18" id="map" noAttributionControl="true" class="layout flex" noZoomControl="true">
				<!--<leaflet-layers-control id="layers-control" position="bottomright"></leaflet-layers-control>-->

				<!--todo <leaflet-geojson></leaflet-geojson>-->

				<leaflet-tilelayer id="osm" url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" max-zoom="19">
					Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contr.,
					<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>,
					Imagery © <a href="https://mapbox.com">Mapbox</a>
				</leaflet-tilelayer>
			</leaflet-map>

			<!--geomarketing-map id="my-map" maxMarkers="300" class="layout flex"></geomarketing-map-->
			<div id="right" class="layout vertical center">
				<div id="chart" class="chart"></div>
				<div class="layout left" id="selectedRegions"></div>
				<paper-button id="reset">Сбросить сравнения</paper-button>
				<div id="explain"></div>
			</div>
		</div>
		<my-controls id="controls"></my-controls>
<!--
		<div class="layout horizontal bottom">
			<div id="params">
				<paper-dropdown-menu label="Показатель">
					<paper-listbox class="dropdown-content">
						<template is="dom-repeat" items="[ 'Средняя сумма заявки на потребительский кредит' ]">
							<paper-item value="{{item.code}}" data-code="{{item.code}}">{{item.text}}</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>

			</div>
			<div id="regions">
				<paper-dropdown-menu label="Регион">
					<paper-listbox class="dropdown-content">
						<template is="dom-repeat" items="[ 'Россия' ]">
							<paper-item value="{{item.code}}" data-code="60189">Россия</paper-item>
							<paper-item value="{{item.code}}" data-code="{{item.code}}">{{item.text}}</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
			</div>
			<div>Период</div>
		</div>
-->
	</div>
</body>
</html>
